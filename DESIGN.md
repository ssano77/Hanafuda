# こいこい ゲーム設計書

## 1. 概要

2人で遊ぶ花札のゲーム「こいこい」を実装するための設計書です。プレイヤーは12ヶ月（ラウンド）を通して、手札と山札から引いた札を場札と合わせることで役を作り、より多くの文（点数）を獲得することを目指します。

## 2. 実装されたゲームの構成要素

### 2.1. カード (Card)

花札48枚を表現します。各カードは以下の属性を持ちます。

-   **月 (month):** 1月から12月
-   **種類 (category):** `hikari`, `tane`, `tan`, `kasu`
-   **名前 (name):** "Tsuru", "Uguisu" など
-   **点数 (points):** カードの基本点数（光札20点、種札10点など）
-   **プレースホルダー画像:** カードの視覚的表示のための色分け

### 2.2. デッキ (Deck)

48枚のカードの集合を管理します。

-   **機能:**
    -   `shuffle()`: 山札をランダムに並び替える
    -   `deal(num_cards)`: 山札の上から指定枚数カードを取り出す
    -   `is_empty()`: 山札が空かどうかを判定

### 2.3. プレイヤー (Player)

ゲームに参加するプレイヤー（人間とCPU）の状態を管理します。

-   **属性:**
    -   `name`: プレイヤー名（"You", "CPU"）
    -   `is_cpu`: CPUプレイヤーかどうかのフラグ
    -   `hand`: 手に持っているカードのリスト
    -   `captured_cards`: 獲得したカードのリスト
    -   `yaku_list`: 現在成立している役のリスト
    -   `total_score`: ゲーム全体での獲得点数
    -   `monthly_score`: 現在のラウンドでの獲得点数
    -   `has_koikoied`: こいこいを宣言したかどうかのフラグ
    -   `is_parent`: 親プレイヤーかどうかのフラグ

-   **CPU AI機能:**
    -   戦略的なカード選択（場札とのマッチングを優先）
    -   価値の高いカードの優先取得
    -   こいこい判断の簡易AI

### 2.4. 場 (Field)

プレイヤーがカードを出す「場」を管理します。

-   **属性:**
    -   `cards`: 場に出ているカードのリスト
-   **機能:**
    -   `find_matches(card)`: 指定カードと同じ月のカードを検索
    -   `add_cards(cards)`: 場にカードを追加
    -   `remove_card(card)`: 場から特定のカードを削除
    -   `clear()`: 場のカードをすべて削除

### 2.5. 役 (Yaku)

こいこいの役を判定し、点数を計算します。

-   **実装された役:**
    -   光札系：五光、四光、雨四光、三光
    -   種札系：猪鹿蝶、種札（5枚以上）
    -   短冊系：赤短、青短、短冊札（5枚以上）
    -   特殊役：花見で一杯、月見で一杯
    -   カス札：10枚以上

## 3. 実装されたゲームフロー

### 3.1. 準備フェーズ

1.  **親決め:** プレイヤーのどちらかをランダムに「親」に決定
2.  **デッキの初期化:** 48枚のカードを持つデッキを生成し、シャッフル
3.  **札配り:**
    -   各プレイヤーに8枚ずつ手札を配布
    -   場に8枚のカードを表向きに配置
    -   残りのカードを山札として保持

### 3.2. プレイフェーズ (1ラウンド)

親プレイヤーから開始し、以下の手順を繰り返します：

1.  **手札選択:** 
    -   人間プレイヤー：マウスクリックでカード選択
    -   CPUプレイヤー：AI判断による自動選択（1秒遅延）

2.  **場札との照合 (手札):**
    -   場に同じ月のカードがあれば両方取得
    -   場に同じ月のカードがなければ、出したカードが場に追加

3.  **山札から引く:** 山札から1枚自動で引いて場に公開

4.  **場札との照合 (山札):**
    -   場に同じ月のカードがあれば両方取得
    -   場に同じ月のカードがなければ、引いたカードが場に追加

5.  **役判定:** カード取得後、新たな役が成立したかを自動判定

6.  **こいこい or 勝負:**
    -   人間プレイヤー：ダイアログで「こいこい」「勝負」を選択
    -   CPUプレイヤー：簡易AI判断（一度だけこいこい、その後勝負）

### 3.3. 点数計算フェーズ

-   「勝負」が宣言されるとラウンド終了
-   成立した役の合計点を獲得
-   相手が「こいこい」していた場合、獲得点数2倍
-   役の合計点が7点以上の場合、獲得点数2倍
-   手札が尽きた場合は獲得カス札枚数で勝敗判定

### 3.4. 終了フェーズ

-   12ラウンド終了後、合計点が最も高いプレイヤーの勝利
-   ラウンド勝者が次の親となる
-   ゲーム終了後はリスタート可能

## 4. UI/UX実装

### 4.1. 画面レイアウト

-   **CPUエリア:** 上部にCPUの手札（裏面）と獲得カード表示
-   **場エリア:** 中央に場札を表示
-   **プレイヤーエリア:** 下部にプレイヤーの手札表示
-   **情報エリア:** 右側にスコア、ターン、役情報を表示

### 4.2. インタラクション

-   **マウス操作:** カード選択、ボタンクリック
-   **キーボード操作:** ESCキーでゲーム終了
-   **視覚フィードバック:** ホバー効果、ハイライト表示

### 4.3. ダイアログシステム

-   **こいこい選択:** 役成立時の選択ダイアログ
-   **ラウンド終了:** 結果表示と次ラウンドへの進行
-   **ゲーム終了:** 最終結果とリスタートオプション

## 5. 技術実装詳細

### 5.1. 使用技術

-   **Python 3.12+**
-   **Pygame 2.6.1+** (グラフィック描画とイベント処理)

### 5.2. アーキテクチャ

-   **MVC パターン:**
    -   Model: GameController, Player, Field, Deck, Card, Yaku
    -   View: UIManager
    -   Controller: main.py でのイベントループ

### 5.3. エラーハンドリング

-   不正なカード選択の防止
-   空のデッキ・手札の適切な処理
-   例外発生時の安全な終了

## 6. 役と点数一覧（実装版）

## 6. 役と点数一覧（実装版）

| 役の名前      | 点数 | 構成条件                                      | 実装状況 |
| :------------ | :--- | :-------------------------------------------- | :------- |
| **五光**      | 10点 | 光札 5枚                                      | ✅ 実装済 |
| **四光**      | 8点  | 光札 4枚 (柳に小野道風を含まない)             | ✅ 実装済 |
| **雨四光**    | 7点  | 光札 4枚 (柳に小野道風を含む)                 | ✅ 実装済 |
| **三光**      | 5点  | 光札 3枚 (柳に小野道風を含まない)             | ✅ 実装済 |
| **猪鹿蝶**    | 5点  | 萩に猪、紅葉に鹿、牡丹に蝶                    | ✅ 実装済 |
| **赤短**      | 5点  | 松、梅、桜の短冊                              | ✅ 実装済 |
| **青短**      | 5点  | 牡丹、菊、紅葉の青短冊                        | ✅ 実装済 |
| **花見で一杯**| 5点  | 桜に幕、菊に盃                                | ✅ 実装済 |
| **月見で一杯**| 5点  | 芒に月、菊に盃                                | ✅ 実装済 |
| **種**        | 1点+ | 種札 5枚。以降1枚増えるごとに+1点             | ✅ 実装済 |
| **短冊**      | 1点+ | 短冊札 5枚。以降1枚増えるごとに+1点           | ✅ 実装済 |
| **カス**      | 1点+ | カス札 10枚。以降1枚増えるごとに+1点          | ✅ 実装済 |

## 7. カード一覧（実装版）

### 光札 (Hikari) - 5枚
- **1月松:** 松に鶴 (Tsuru) - 20点
- **3月桜:** 桜に幕 (Maku) - 20点  
- **8月芒:** 芒に月 (Tsuki) - 20点
- **11月柳:** 柳に小野道風 (Ono no Michikaze) - 20点
- **12月桐:** 桐に鳳凰 (Ho-oh) - 20点

### 種札 (Tane) - 9枚
- **2月梅:** 梅に鶯 (Uguisu) - 10点
- **4月藤:** 藤に不如帰 (Hototogisu) - 10点
- **5月菖蒲:** 菖蒲に八橋 (Yatsuhashi) - 10点
- **6月牡丹:** 牡丹に蝶 (Chou) - 10点
- **7月萩:** 萩に猪 (Inoshishi) - 10点
- **8月芒:** 芒に雁 (Gan) - 10点
- **9月菊:** 菊に盃 (Sakazuki) - 10点
- **10月紅葉:** 紅葉に鹿 (Shika) - 10点
- **11月柳:** 柳に燕 (Tsubame) - 10点

### 短冊札 (Tan) - 10枚
- **1月松:** 松の赤短 (Akatan) - 5点
- **2月梅:** 梅の赤短 (Akatan) - 5点
- **3月桜:** 桜の赤短 (Akatan) - 5点
- **4月藤:** 藤の短冊 (Tan) - 5点
- **5月菖蒲:** 菖蒲の短冊 (Tan) - 5点
- **6月牡丹:** 牡丹の青短 (Aotan) - 5点
- **7月萩:** 萩の短冊 (Tan) - 5点
- **9月菊:** 菊の青短 (Aotan) - 5点
- **10月紅葉:** 紅葉の青短 (Aotan) - 5点
- **11月柳:** 柳の短冊 (Tan) - 5点

### カス札 (Kasu) - 24枚
- 各月2〜3枚のカス札 - 1点

## 8. 今後の拡張可能性

### 8.1. 追加機能候補
- 実際の花札画像の実装
- サウンド効果・BGM
- アニメーション効果
- より高度なCPU AI
- ネットワーク対戦機能
- 統計情報の保存

### 8.2. ルールバリエーション
- 地域別ルール（関西、関東など）
- 手四・くっつきの処理
- 追加役の実装
- 点数計算方法の選択

### 8.3. UI/UX改善
- レスポンシブデザイン
- タッチ操作対応
- カスタマイズ可能なテーマ
- 多言語対応
